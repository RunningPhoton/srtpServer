package com.demo.actions;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;

import com.demo.database.data.TDemoCircle;
import com.demo.database.data.TDemoCircleMessage;
import com.demo.database.data.TDemoIMessage;
import com.demo.database.data.TDemoImplMessage;
import com.demo.database.data.TDemoImplUser;
import com.demo.database.data.TDemoMessage;
import com.demo.database.data.TDemoUser;
import com.demo.database.idao.IDaoService;
import com.demo.services.IUserService;
import com.demo.tools.Tools;
import com.opensymphony.xwork2.ActionContext;
import com.opensymphony.xwork2.ActionSupport;

public class UserAction extends ActionSupport {
	private TDemoUser user;
	private String operObject;
	private String operContent;
	private IUserService iuserService;
	private String result;
	
	

	public IUserService getIuserService() {
		return iuserService;
	}

	public void setIuserService(IUserService iuserService) {
		this.iuserService = iuserService;
	}

	public TDemoUser getUser() {
		return user;
	}

	public void setUser(TDemoUser user) {
		this.user = user;
	}

	public String getOperObject() {
		return operObject;
	}

	public void setOperObject(String operObject) {
		this.operObject = operObject;
	}

	public String getOperContent() {
		return operContent;
	}

	public void setOperContent(String operContent) {
		this.operContent = operContent;
	}
	
	/**
	 * 列出用户添加的关注的人的信息
	 * @return
	 */
	public String listWhoIAdd() {
		try {
			TDemoUser tempUser = iuserService.findByUserName(this.user.getUserName());
			return listUserSets(tempUser.getUserFriendSet());
		} catch (Exception e) {
			System.out.println(e);
			return ERROR;
		}
	}
	/**
	 * 列出该用户被哪些人添加了
	 * @return
	 */
	public String listWhoAddMe() {
		try {
			TDemoUser tempUser = iuserService.findByUserName(this.user.getUserName());
			return listUserSets(tempUser.getUserBeenFriendSet());
		} catch (Exception e) {
			System.out.println(e);
			return ERROR;
		}
	}
	/**
	 * 将TDemoUser的集合转化为json字符串
	 * @param objSet
	 * @return
	 */
	public String listUserSets(Set<TDemoUser> objSet) {
		this.result = null;
		if(objSet == null) {
			return SUCCESS;
		}
		Tools tool = new Tools();
		Iterator iter = objSet.iterator();
		Set<Object> obj = new HashSet<Object>();
		while(iter.hasNext()) {
			TDemoUser cur =  (TDemoUser) iter.next();
			TDemoImplUser temp = new TDemoImplUser(cur.getUserName(), 
					cur.getUserNickname(), cur.getUserGender(), cur.getUserCollege(), cur.getGraphName());
			obj.add(temp);
		}
		this.result = tool.setToJson(obj);
		return SUCCESS;
	}
	/**
	 * 将operObject作为圈子名，来查找圈子，在返回json字符串表示圈子信息
	 * @param objSet
	 * @return
	 */
	public String listCircleMessageSets() {
		try {
			TDemoCircle circle = iuserService.findByCircleName(operObject);
			return listMessageSets(Set<TDemoIMessage> circle.getMessageSet());
		} catch (Exception e) {
			System.out.println(e);
			return ERROR;
		}
	}
	/**
	 * 将消息的集合转化为json字符串
	 * 
	 */
	public String listMessageSets(Set<TDemoIMessage> objSet) {
		if(objSet == null) {
			this.result = null;
			return SUCCESS;
		}
		Tools tool = new Tools();
		Iterator iter = objSet.iterator();
		Set<Object> obj = new HashSet<Object> ();
		
		while(iter.hasNext()) {
			TDemoIMessage cur = (TDemoIMessage) iter.next();
			TDemoImplMessage temp = new TDemoImplMessage(cur.getUserName(), 
					cur.getContent(), cur.getOpertime());
			obj.add(temp);
		}
		this.result = tool.setToJson(obj);
		return SUCCESS;
	}
	/**
	 * 更新用户信息，更新成功之后返回该用户新信息json，失败返回null
	 * @return
	 */
	public String update() {
		TDemoUser tempUser = iuserService.findByUserName(this.user.getUserName());
		tempUser.setUserGender(this.user.getUserGender());
		tempUser.setUserCollege(this.user.getUserCollege());
		tempUser.setUserNickname(this.user.getUserNickname());
		tempUser.setUserPassword(this.user.getUserPassword());
		tempUser.setGraphName(this.user.getGraphName());
		this.user = tempUser;
		System.out.println("执行update");
		if(iuserService.update(this.user)) {
			Set<TDemoUser> obj = new HashSet<TDemoUser>();
			obj.add(this.user);
			return listUserSets(obj);
		} else {
			this.result = null;
		}
		return SUCCESS;
	}
	
	public String addFriend() {
		this.user = iuserService.findByUserName(this.user.getUserName());
		try {
			System.out.println("执行addFriend");
			iuserService.addFriend(this.user, operObject);
			System.out.println("success执行addFriend");
			
			ActionContext.getContext().getSession().put("user", this.user);
			return SUCCESS;
		} catch (Exception e) {
			return ERROR;
		}
	}
	public String removeFriend() {
		this.user = iuserService.findByUserName(this.user.getUserName());
		try {
			iuserService.removeFriend(this.user, operObject);

			ActionContext.getContext().getSession().put("user", this.user);
			return SUCCESS;
		} catch (Exception e) {
			return ERROR;
		}
	}
	public String setCircle() {
		this.user = iuserService.findByUserName(this.user.getUserName());
		try {
			System.out.println("执行setCircle");
			iuserService.setCircle(this.user, operObject);

			ActionContext.getContext().getSession().put("user", this.user);
			return SUCCESS;
		} catch (Exception e) {
			return ERROR;
		}
	}
	public String removeCircle() {
		this.user = iuserService.findByUserName(this.user.getUserName());
		try {
			System.out.println("执行removeCircle");
			iuserService.removeCircle(this.user, operObject);

			ActionContext.getContext().getSession().put("user", this.user);
			return SUCCESS;
		} catch (Exception e) {
			return ERROR;
		}
	}
	public String sendUserMessage() {
		this.user = iuserService.findByUserName(this.user.getUserName());
		try {
			System.out.println("执行sendUserMessage");
			iuserService.sendUserMessage(this.user, operContent, operObject);
			
			ActionContext.getContext().getSession().put("user", this.user);
			return SUCCESS;
		} catch (Exception e) {
			return ERROR;
		}
	}
	public String sendCircleMessage() {
		this.user = iuserService.findByUserName(this.user.getUserName());
		try {
			System.out.println("sendCircleMessage");
			iuserService.sendCircleMessage(this.user, operContent);

			System.out.println("success sendCircleMessage");
			return SUCCESS;
		} catch (Exception e) {
			return ERROR;
		}
	}
}
