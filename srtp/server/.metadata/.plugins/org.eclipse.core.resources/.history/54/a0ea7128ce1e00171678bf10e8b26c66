package com.demo.services.impl;

import java.sql.Timestamp;
import java.util.List;

import com.demo.database.data.TDemoCircle;
import com.demo.database.data.TDemoCircleMessage;
import com.demo.database.data.TDemoMessage;
import com.demo.database.data.TDemoUser;
import com.demo.database.idao.IDaoService;
import com.demo.services.IUserService;


/**
 * 用户操作业务逻辑实现类
 * @author runningphoton
 *
 */
public class UserService implements IUserService {
	private IDaoService idaoService;
	private TDemoUser user;

	public IDaoService getIdaoService() {
		return idaoService;
	}

	public void setIdaoService(IDaoService idaoService) {
		this.idaoService = idaoService;
	}

	public TDemoUser getUser() {
		return user;
	}

	public void setUser(TDemoUser user) {
		this.user = user;
	}

	/**
	 * 通过userName来找到用户
	 */
	@Override
	public TDemoUser findByUserName(String userName) {
		String hql = "from TDemoUser where userName='"+userName+"'";
		try {
			List<TDemoUser> list = (List<TDemoUser>) idaoService.query(hql);
			if(list != null) 
				return list.get(0);
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
		return null;
	}

	/**
	 * 通过ciecleName来查找circle，找不到就创建一个
	 */
	@Override
	public TDemoCircle findByCircleName(String circleName) {
		String hql = "from TDemoCircle where circleName='" + circleName + "'";
		List<TDemoCircle> list;
		try {
			list = (List<TDemoCircle>) idaoService.query(hql);
			if(list == null) {
				TDemoCircle circle = new TDemoCircle();
				circle.setCircleName(circleName);
				return circle;
				circle.addUser(this.user);
			}
			return list.get(0);
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
	}

	/**
	 * 用数据库中最新的数据来刷新user
	 */
	@Override
	public void fresh() throws Exception {
		this.user = findByUserName(this.user.getUserName());
	}

	/**
	 * 添加朋友
	 */
	@Override
	public void addFriend(TDemoUser user) throws Exception {
		this.user.addFriend(user);
		idaoService.update(this.user);
	}

	/**
	 * 删除朋友，传入朋友的用户名
	 */
	@Override
	public void removeFriend(String userName) throws Exception {
		TDemoUser user = new TDemoUser();
		user = this.findByUserName(userName);
		this.user.removeFriend(user);
		idaoService.update(this.user);
	}

	/**
	 * 设置圈子
	 */
	@Override
	public void setCircle(TDemoCircle circle) throws Exception {
		this.user.setUserCircle(circle);
		idaoService.update(this.user);
	}

	/**
	 * 移除圈子
	 */
	@Override
	public void removeCircle(TDemoCircle circle) throws Exception {
		this.user.setUserCircle(null);
		idaoService.update(this.user);
	}

	/**
	 * 发送用户信息，修改必改属性，传入的message只包含内容
	 */
	@Override
	public void sendUserMessage(TDemoMessage message, TDemoUser to) throws Exception {
		this.user.getUserMessageSendSet().add(message);
		to.getUserMessageGetSet().add(message);
		message.setInferiorUser(to);
		message.setMainUser(this.user);
		message.setOpertime(new Timestamp(System.currentTimeMillis()));
		idaoService.save(message);
		idaoService.update(this.user);
		idaoService.update(to);
	}

	@Override
	public void sendCircleMessage(TDemoCircleMessage circleMessage)
			throws Exception {
		// TODO Auto-generated method stub

	}

	@Override
	public void addFriend(String userName) throws Exception {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void setCircle(String circleName) throws Exception {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void removeCircle(String circleName) throws Exception {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void sendUserMessage(String messageContent, String UserName)
			throws Exception {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void sendCircleMessage(String circleMessage) throws Exception {
		// TODO Auto-generated method stub
		
	}

}
